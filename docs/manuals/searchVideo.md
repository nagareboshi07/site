# ニコニコ動画検索シート

## 概要
Googleスプレッドシート＋GoogleAppsScriptを使用したニコニコ動画検索ツールです。  
ニコニコ動画の検索結果をシートに表示します。  
検索で取得した動画IDに対し、getthumbinfoAPIを用いることで、詳細情報を取得します。

---

## 目次
- [シートの説明](#シートの説明)
- [サポート情報](#サポート情報)
- [配布先](#配布先)
- [API検索の使用方法](#API検索の使用方法)
- [HTML解析の使用方法【非推奨】](#HTML解析の使用方法【非推奨】)
- [詳細情報取得の使用方法](#詳細情報取得の使用方法)
- [利用規約](#利用規約)
- [更新履歴](#更新履歴)

---

## シートの説明  
- サポート情報シート
  - 使用中のバージョンのサポート情報を表示する
- API検索設定 シート  
  - 各種APIで検索を行う際の設定を行うシート  
- HTML解析設定 シート  
  - HTML解析で検索を行う際の設定を行うシート  
- 結果 シート  
  - 検索した結果が追加される。  
- 表示 シート  
  - 結果シートの結果を整形し表示する。  
- ログ シート  
  - 実行時の動作記録を表示する。  

<br>

---
## サポート情報
- 原則として、最新版のシートをご使用ください。
- ご使用のニコニコ動画検索シートがサポート中かどうかは、「サポート情報」シートをご参照ください。
- サポート情報が付属していない場合（ver.2.20以前）は、すべてサポートを終了しております。
<br>
---
## 配布先
- [Googleドライブ](https://drive.google.com/drive/folders/1Pk9H2xLO0-Evvtmm52UYJMMhlbpEXvlt)
  - 上記Googleドライブから、マイドライブへコピーしてご使用ください。
<br>
---

## API検索の使用方法
### 1. 「API検索シート」を開く。  
- 取得方式
  - スナップショット検索APIv2  
    AM5時時点のデータを取得する検索方法  
    概ねAM8時～12時までにデータが更新される。  
    > 参考：[ニコニコ動画 『スナップショット検索API v2』 ガイド](https://site.nicovideo.jp/search-api-docs/snapshot.html)
 
### 2. 必要な情報を入力する。

- A. 検索キーワード  
  スナップショット必須
  - 検索時に用いるキーワード（検索方法：ノーキーワードを指定する場合のみ不要）
- B. 検索方法
  - タグ（tags）  
    部分一致するタグを対象とした検索
  - 完全一致タグ（tagsExact）  
    完全に一致するタグのみを対象にした検索
  - キーワード（tags,description,title）  
    タグ、タイトル、説明文のいずれかに部分一致するものを対象とした検索
  - タイトル（title）  
    部分一致するタイトルを対象とした検索
  - 説明文（description）  
    部分一致する説明文を対象とした検索
  - タイトル、タグ (title,tags)
    タグとタイトルのいずれかに部分一致するものを対象とした検索
  - ノーキーワード  
    キーワードを指定しない検索。  
    他のフィルタを利用し、範囲を絞り込むこと（最低でも結果が10万件以内に収まるようにする）
- C. API利用者情報  
  利用者の連絡先情報。（例：`x：@07nagareboshi`）  
  ※検索シートの暴走などの際にニコニコ運営から連絡を取るための情報。
- D. フィルタ  
  検索する上での制限範囲を設定する  
  指定可能なパラメータは、[ニコニコ動画 『スナップショット検索API v2』 ガイド](https://site.nicovideo.jp/search-api-docs/snapshot.html) 参照
- E. 並び替え  
  結果の表示順を指定する  
  - 昇順：1→2→3→...と表示
  - 降順：3→2→1→...と表示  
  例：再生数の多い順に表示する場合  
    「再生数」「降順」と設定する
- F. オフセット（開始）、オフセット（終了）    
  取得開始地点と取得終了地点を指定する。  
  例えば、開始：100、終了：1000の場合は、結果の100件目～1000件目のみ取得する。  
  ※内部的には、開始～終了までを100ずつ繰り上げながら、繰り返し実行している。
- G. 最大数
  APIの実行1回毎の取得数を指定する。  
  特に理由がない場合は、100（最大値）。  
  ※オフセット（開始）、（終了）を指定している場合は、100に固定される。

### 3. 上部メニューの、「ツール」→マクロから検索方法をクリックする。  
※ 初回実行時は、GASのアクセス権の承認が必要です。  
- API検索_通常  
  検索した情報のうち、未登録の情報を追加するモード。  
  既に取得済みの情報の更新は行わない。
- API検索_データ更新  
  検索した情報を追記し、また取得済みの情報の更新も行うモード。  
<br>

---

## HTML解析の使用方法【非推奨】  
ニコニコの検索ページのソースを解析する方式です。  
サーバに負荷をかけるため、可能な限り使用しないでください。  
注意：デバイス制限対象の動画は、取得できません。  

### 旧検索ページを使用する検索について
2025年8月にリリースされる以前の検索ページを使用した検索モードを使用する場合は、「HTML解析_旧検索」を使用してください。  
新検索ページを使用したHTML解析の不具合時にのみ使用してください。  
「HTML解析_旧検索」の解析処理では、[Parserライブラリ](https://script.google.com/home/projects/1Mc8BthYthXx6CoIz90-JiSzSafVnT6U3t0z_W3hLTAX5ek4w0G_EIrNw)を使用しています。  

### 1. 「HTML解析設定」シートを開く

### 2. 必要な情報を入力する。  
- 検索方法（必須）
  - キーワード
  - 完全一致タグ
- 検索キーワード（必須）  
  検索時に用いるキーワード  
- 取得ページ(必須)  
  検索ページの何ページから何ページまで取得するかを指定する。  
  ※開始は原則、1。
- 並び替え（必須）  
  並び替え順を指定する。  
- フィルタ（任意）  
  情報の絞り込みを行う  
  - 投稿日時  
    「日付を指定」の場合は、開始日、終了日を指定する（どちらかのみ指定も可）  
  - ジャンル  
    動画のジャンルから選択する。  
  - 再生時間  
    5分以下、20分以上、指定なしから選択。

### 3. 上部メニューの、「ツール」→「マクロ」→「HTML解析」をクリックする。  
※初回実行時は、GASのアクセス権の承認が必要です。
- 一度に取得する最大数は800件です。  
<br>

---

## 詳細情報取得の使用方法
※事前にスナップショット検索APIv2もしくはHTML解析による検索を行い、動画IDがシートに記録されている必要があります。  
### 1. 上部メニューの、「ツール」→「マクロ」→「詳細情報取得」をクリックする。    
※ 初回実行時は、GASのアクセス権の承認が必要です。   
<br> 

---
## 利用規約
- 本ツールは「GoogleApps」の仕組みにより動作しております。  
そのため、「GoogleApps」及び関連サービスが停止した場合、利用ができません。
- 本ツールは、予告なく利用できなくなる場合があります。
- 本ツールの利用時に発生した不具合について、制作者に問い合わせいただくことは可能ですが、修正をお約束するものではありません。
- 本ツールを利用したこと、及び利用できなかったことにより発生したトラブルについて、制作者は一切の責任を負いかねます。
- 「GoogleApps」及び「ニコニコ関連サービス」へ過剰な負荷をかけるような使用方法を禁止します。
- 本ツールの改造、及び改造しての利用を禁止します。
- 再配布を禁止します。
---
## 更新履歴
### ver.2.40V (2025/9/1) [ニコニコ動画 専用バージョン]
- 留意事項
  - タグロックチェッカーは開発中のため、本バージョンでは使用できません。
- 機能追加/仕様変更
  - HTMLスクレイピング検索で使用するページを新検索ページに変更
  - HTMLスクレイピング検索で旧検索ページを使用するモードを追加
- 不具合修正
  - HTMLスクレイピング検索において、複数ページに渡っている場合のページの出力順が誤っている点の修正
### ver.2.30V (2024/4/1) [ニコニコ動画 専用バージョン]
- 留意事項
  - タグロックチェッカーは開発中のため、本バージョンでは使用できません。
- API仕様変更の対応
  - 接続先FQDNを変更
### ver.2.20V (2023/12/31) [ニコニコ動画 専用バージョン]
- 留意事項
  - タグロックチェッカーは開発中のため、本バージョンでは使用できません。
- API仕様変更の対応
  - APIに対しSSL接続のみとなったため、アクセス方法を変更
- 機能追加
  - サポート情報シートを追加

### ver.2.11V (2022/2/26) [ニコニコ動画 専用バージョン]
- 留意事項
  - タグロックチェッカーは開発中のため、本バージョンでは使用できません。
- 不具合修正
  - 詳細情報取得処理で、想定より1本多く情報を取得する不具合の修正
  - API検索で、オフセット(終了)のチェックを外し、かつ最大数のチェックをつけた場合、ログに「（デフォルト）」と表示される不具合の修正
  - スナップショット検索APIを使用し、かつ投稿日時のフィルタを使用した場合、投稿日時の表示が誤った値が記録される不具合の修正
  - スナップショット検索APIを使用し、かつ投稿日時のフィルタを使用し、「含む？」の設定を行わなかった場合、ログに（含まない）が記録されない不具合の修正
  - v1APIを使用し、「オフセット(終了)」に1601以上の数字を入力した場合にエラーが発生する不具合の修正
  ※1601以上の数字を指定した場合も、1600が入力されたものとして取り扱う。
  - v1APIを使用し、「最大数」を指定せず、かつ51以上の数字が指定されていた場合に、ログの最大取得数が100として記録される不具合の修正
  - v1APIを使用し、オフセット(終了)のチェックを外し、かつ最大数のチェックを外した場合、本来50と記録されるはずが、100と記録される不具合の修正

### ver.2.10V (2022/1/4)　[ニコニコ動画 専用バージョン]
- 留意事項
  - 本バージョンはver.2.04以前のバージョンとのスクリプトの互換性はありません。
  - タグロックチェッカーは開発中のため、本バージョンでは使用できません。
- 機能追加
  - 実行ログをdiscordに転送する機能を追加
  - 検索結果の書き込み先を外部スプレッドシートに指定する機能を追加
    - 外部スプレッドシートに検索結果の書き込み先用シートを作成する機能を追加
  - マイリスト読み込み機能を追加
  - 結果シートを削除する機能を追加
  - 結果シートから空行を削除する機能を追加
  - 結果シートから指定した列を削除する機能を追加
    - 列の削除後は結果シートへの検索結果の出力不可になります。
- 内部処理変更
  - V8ランタイムで使用可能になった構文に修正。
    - 今後はChrome V8ランタイムのみのサポートとし、Rhinoランタイムは動作対象外とします。
  - スクリプトの.gsファイルを整理し、utilities.gsとcomponents.gsに分離。
    - utilities.gs：その他機能
    - components.gs：スクリプト内での使用を前提とした機能群

### ver.2.04V (2021/08/16)　[ニコニコ動画 専用バージョン]
- API仕様変更の対応
  - スナップショット検索APIにおいて、likeCounter(いいね数)をsort(並び替え順)、filter(フィルタ)に指定できるように変更。
  - スナップショット検索APIにおいて、contentId(コンテンツID)をfilterに指定できるよう変更。

### ver.2.03V (2021/06/26)　[ニコニコ動画 専用バージョン]
- 不具合修正
  - 詳細情報取得処理において、取得対象が1本のみの場合、情報取得を行わない不具合を修正。

### ver.2.02V (2021/06/20)　[ニコニコ動画 専用バージョン]
- 不具合修正
  - v1APIにおいて、動画が複数回取得される場合がある不具合を修正。

### ver.2.01V (2021/06/16)　[ニコニコ動画 専用バージョン]
- 不具合修正
  - スナップショット検索において、情報が取得できない問題を修正。

### ver.2.00V (2021/05/28)　[ニコニコ動画 専用バージョン]
- コンテンツ検索APIの廃止に伴う対応
  - v1APIによる検索処理を追加。
  - HTML解析処理を追加
    - 検索ページをスクレイピングし、ID一覧を取得し更新する。
- スナップショット検索APIで取得できる情報の増加に合わせ、取得情報を追加、整理した。
- シートを全体的に修正した。
  - configシートは、API検索設定、HTML解析設定に分離し、それぞれ作成。
  - 結果シートには取得情報のみを掲載する仕様に変更。
  - その他全体的に修正。
- ログの書式を変更し、見やすくした。
- コードを全体的にリファクタリングした。

### ver.1.20(2019/03/10)
- 機能追加
  - アペンド/情報更新検索を追加
    - この検索方法では、すでに検索済みの結果もコンテンツID以外の値を修正します。
  - 対応サービスにニコニ・コモンズ(commons)を追加

### ver.1.11(2019/02/22)
- 処理変更
  - 検索の設定値を全処理でログとして残していたが、検索処理以外には載せない仕様に変更。

### ver.1.10(2019/02/20)
- 不具合修正
  - 検索対象が0件の場合にエラーが出て異常終了する問題を修正。
- 機能追加
  - 「log」シートを追加。
    - 各種処理を行う毎にデータを記録します。
- 処理変更
  - 検索処理後に200以外のステータスが返ってきた場合、エラーを返し処理を終了するように修正。

### ver.1.03(2019/01/16)
- 不具合修正
  - illustに対して詳細情報を取得する際、投稿者名が取得できない場合にエラーにより処理を完了できない問題を修正。


### ver.1.02(2018/11/03)
- 不具合修正
  - 詳細情報取得処理において、取得対象の動画が削除済み/非公開の場合、エラーが出る問題を修正。
  - データ未取得時にアペンド検索を使用すると検索が完了できない問題を修正。
  - アペンド検索で、シートに追加するデータが無いときにエラーが出る問題を修正。


### ver.1.01(2018/10/27)
- 不具合修正
  - 詳細情報取得処理において、取得する動画数が0以下のときにエラーが出る問題を修正。


### ver.1.00(2018/10/24)
- 検索シートとして基本的な機能の実装。
- スナップショット検索の集計日取得の実装。表示はないがエディタのログで閲覧可能。
