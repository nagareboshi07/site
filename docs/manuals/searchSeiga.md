# ニコニコ静画検索シート

## 概要
ニコニコ静画の検索結果(コンテンツID)をシートに表示します。
IDから、APIを用いることで、各種情報を取得します。

## 使用方法

### 1. configシートを開き、検索する情報を入力する。
  - 取得方式
    - HTML解析(静画/検索ページ)
    ニコニコ静画の検索ページのHTMLを読み込む検索方法
  - 検索キーワード
    - 検索時に用いるキーワード
  - 検索方法
    - 完全一致タグ
    完全に一致するタグのみを対象にした検索
    - キーワード検索
    タイトル/タグ/静画説明文のいずれかに含まれたものを対象にした検索
  - 対象サービス
    - イラスト
    - 漫画検索は未実装
  - 並び替え
    - ニコニコ静画の検索ページ上で利用ができる並び替えに準じる。
  - 結果ページ数
    HTML検索実行時の、取得するページの開始と終了を指定する。
  
    制限：合計100ページ/一回の検索処理
    - キーワード検索：1ページ20件
    - タグ検索：1ページ40件

### 2. 検索を実行する
上部メニューの、「ツール」→マクロから検索方法を選択する。  
※ 初回実行時は、GASのアクセス権の承認が必要です。  
- 新規検索
  - すでに検索済みのデータをすべて消してから、検索を行う。
- アペンド検索
  - 既存のデータを残して、そのデータに追記する形で検索を行う。  
すでに入っているコンテンツは重複で登録しない。

### 3. 詳細情報取得
上部メニューの、「ツール」→「マクロ」→「詳細情報取得」を選択する。    
※ 初回実行時は、GASのアクセス権の承認が必要です。  


## 検索結果の確認方法

### resultシート
- 検索した結果が追加される。  

### filterシート
- resultシートの結果を整形し表示する。  

### logシート
- 実行時の動作記録を表示する。

## サーバ負荷対策
  - 検索処理
    - 1ページごとに1秒の待機時間をとっています。
    - また、5ページごとに通常より長い待機時間をとっています。
  - 詳細情報取得処理
    - 1イラストの情報取得ごとに1秒の待機時間をとっています。


## UpdateLog

### ver.2.10 S (2019/08/24)　[ニコニコ静画 専用バージョン]
- 機能追加
  - 検索結果の順番を反転させて表示する機能の追加
- 処理変更
  - 詳細情報取得処理で一度に処理できる件数の上限を200に変更した。
- バグ修正
  - 上限数を超える場合にエラーが出る問題を修正した。

### ver.2.00 S (2019/08/09)　[ニコニコ静画 専用バージョン]
- コンテンツ検索APIの変更における修正
  - HTML解析(静画/検索ページ)モードを追加(静画)
    - 検索ページをスクレイピングし、ID一覧を取得し更新する。
  - APIによる情報取得処理を追加(静画)
- コードを全体的にリファクタリングした。

### ver.1.20(2019/03/10)
- 機能追加
  - アペンド/情報更新検索を追加
    - この検索方法では、すでに検索済みの結果もコンテンツID以外の値を修正します。
  - 対応サービスにニコニ・コモンズ(commons)を追加

### ver.1.11(2019/02/22)
- 処理変更
  - 検索の設定値を全処理でログとして残していたが、検索処理以外には載せない仕様に変更。

### ver.1.10(2019/02/20)
- 不具合修正
  - 検索対象が0件の場合にエラーが出て異常終了する問題を修正。
- 機能追加
  - 「log」シートを追加。
    - 各種処理を行う毎にデータを記録します。
- 処理変更
  - 検索処理後に200以外のステータスが返ってきた場合、エラーを返し処理を終了するように修正。

### ver.1.03(2019/01/16)
- 不具合修正
  - illustに対して詳細情報を取得する際、投稿者名が取得できない場合にエラーにより処理を完了できない問題を修正。


### ver.1.02(2018/11/03)
- 不具合修正
  - 詳細情報取得処理において、取得対象の動画が削除済み/非公開の場合、エラーが出る問題を修正。
  - データ未取得時にアペンド検索を使用すると検索が完了できない問題を修正。
  - アペンド検索で、シートに追加するデータが無いときにエラーが出る問題を修正。


### ver.1.01(2018/10/27)
- 不具合修正
  - 詳細情報取得処理において、取得する動画数が0以下のときにエラーが出る問題を修正。


### ver.1.00(2018/10/24)
- 検索シートとして基本的な機能の実装。
- スナップショット検索の集計日取得の実装。表示はないがエディタのログで閲覧可能。
